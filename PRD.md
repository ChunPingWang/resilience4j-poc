# 業務需求計劃書（PRD）

## Resilience4j Retry + CircuitBreaker + TimeLimiter PoC — 電子商務場景

---

**文件版本**: 1.0  
**建立日期**: 2026-02-02  
**文件狀態**: Draft  
**負責人**: 架構組  

---

## 1. 背景與動機

### 1.1 業務背景

本公司電子商務平台採用微服務架構，核心交易流程涉及多個外部與內部服務的協作：訂單服務需呼叫庫存服務扣減庫存、呼叫支付閘道完成扣款、呼叫物流服務建立出貨單。任何一個環節的暫時性失敗或回應過慢，都會直接衝擊使用者體驗與營收。

### 1.2 現況問題

目前系統在面對下游服務異常時，存在以下具體痛點：

- **連鎖雪崩**：支付閘道發生 5 秒以上延遲時，上游訂單服務的執行緒池在 30 秒內耗盡，導致整個結帳流程不可用。2025 年 Q4 發生 3 次此類事件，平均影響時長 45 分鐘，估計損失營收約 NT$120 萬。
- **無效重試風暴**：庫存服務短暫不可用時，訂單服務以固定間隔無限重試，在 10 分鐘內產生超過 50 萬次無效請求，加劇下游負載並延長故障恢復時間。
- **無超時控制**：物流服務偶發的慢查詢（P99 達 12 秒）導致呼叫端長期阻塞，使用者在結帳頁面看到無盡的 loading 狀態。

### 1.3 PoC 目標

透過 Resilience4j 的三種核心模式組合（Retry、CircuitBreaker、TimeLimiter），在訂單服務中建立防禦機制的概念驗證，具體驗證以下能力：

1. 對暫時性故障自動重試，提升單次請求成功率
2. 當下游服務持續故障時，快速斷路避免資源浪費
3. 對所有外部呼叫施加超時上限，避免執行緒阻塞
4. 三種模式疊加使用時的協作行為與優先順序

---

## 2. 業務場景與使用者故事

### 2.1 核心業務場景：訂單結帳流程

使用者在電商平台完成商品選擇後，點擊「確認結帳」，系統依序執行：

```
使用者 → [訂單服務] → [庫存服務] 扣減庫存
                     → [支付閘道]  信用卡扣款
                     → [物流服務]  建立出貨單
```

### 2.2 使用者故事

**US-01：暫時性庫存服務故障下的自動復原**

> 身為一名正在結帳的消費者，當庫存服務因網路抖動短暫不可用時，我希望系統能自動重試而非立刻失敗，讓我無感地完成結帳。

驗收標準：
- 庫存服務返回 500/503 時，系統在 2 秒內完成最多 3 次重試
- 重試採用指數退避策略（500ms → 1000ms → 2000ms），避免衝擊下游
- 若 3 次重試均失敗，返回明確錯誤訊息「庫存確認暫時無法完成，請稍後重試」
- 對於 400（參數錯誤）、409（庫存不足）等業務錯誤不觸發重試

**US-02：支付閘道持續故障時的快速失敗**

> 身為一名正在結帳的消費者，當支付閘道持續故障時，我不希望每次結帳都等待漫長的超時，而是立即收到系統提示並可選擇其他支付方式。

驗收標準：
- 當支付閘道在 10 次呼叫中失敗率達 60% 時，斷路器開啟
- 斷路器開啟後，所有請求在 50ms 內收到快速失敗回應
- 斷路器開啟 30 秒後進入半開狀態，允許 5 個探測請求
- 若探測請求成功率 ≥ 60%，斷路器關閉並恢復正常流量
- 快速失敗時返回明確提示「支付服務暫時不可用，請嘗試其他支付方式或稍後重試」

**US-03：物流服務慢回應的超時保護**

> 身為一名正在結帳的消費者，即使物流服務回應緩慢，我也不希望結帳頁面無限 loading，應在合理時間內收到回應。

驗收標準：
- 物流服務呼叫超時上限為 3 秒
- 超時觸發後，記錄逾時事件並返回「物流單號將稍後以通知方式提供」
- 超時事件計入斷路器的失敗統計
- 超時後正確取消底層 HTTP 連線，釋放資源

**US-04：三模式協作下的完整保護**

> 身為系統維運人員，我希望 Retry、CircuitBreaker、TimeLimiter 三種機制能正確協作，確保在各種故障組合下都能提供合理的降級回應。

驗收標準：
- 執行順序為 TimeLimiter → CircuitBreaker → Retry → 實際呼叫
- 單次重試超時由 TimeLimiter 控制，整體重試次數由 Retry 控制
- 斷路器開啟時直接跳過重試邏輯
- 所有韌性事件（重試、斷路、超時）都有結構化日誌與 metrics 輸出

---

## 3. 業務規則與約束

### 3.1 回應時間要求

| 場景 | 正常 P95 | 降級上限 | 快速失敗上限 |
|------|----------|----------|-------------|
| 庫存查詢 | ≤ 500ms | ≤ 4s（含重試） | ≤ 50ms |
| 支付扣款 | ≤ 2s | ≤ 8s（含重試） | ≤ 50ms |
| 物流建單 | ≤ 1s | ≤ 3s（超時保護） | ≤ 50ms |

### 3.2 業務可重試規則

| HTTP 狀態碼 | 含義 | 可重試 | 說明 |
|------------|------|--------|------|
| 500 | 服務端內部錯誤 | ✅ | 暫時性故障 |
| 502 | 閘道錯誤 | ✅ | 網路抖動 |
| 503 | 服務不可用 | ✅ | 暫時過載 |
| 504 | 閘道超時 | ✅ | 下游慢回應 |
| 429 | 限流 | ✅ | 退避後重試 |
| 400 | 參數錯誤 | ❌ | 業務邏輯錯誤 |
| 401/403 | 認證/授權失敗 | ❌ | 非暫時性 |
| 404 | 資源不存在 | ❌ | 業務邏輯錯誤 |
| 409 | 衝突（如庫存不足） | ❌ | 業務狀態衝突 |
| ConnectException | 連線失敗 | ✅ | 網路層故障 |
| SocketTimeoutException | 讀取超時 | ✅ | 下游慢回應 |

### 3.3 降級策略

| 服務 | 降級方式 | 業務影響 |
|------|---------|---------|
| 庫存服務 | 返回錯誤提示，不建立訂單 | 使用者需重試，無資金風險 |
| 支付閘道 | 提示更換支付方式或稍後重試 | 使用者體驗降級，無資金風險 |
| 物流服務 | 先建立訂單，物流單號延後通知 | 使用者可完成結帳，物流延後處理 |

### 3.4 冪等性要求

支付扣款為核心資金操作，重試前必須確保冪等性：
- 每筆支付請求攜帶唯一 idempotency-key
- 支付閘道需支援基於 idempotency-key 的冪等查詢
- PoC 中以 UUID 作為 idempotency-key 模擬此行為

---

## 4. 成功指標（KPI）

### 4.1 PoC 驗證指標

| 指標 | 目標值 | 量測方式 |
|------|--------|---------|
| 暫時性故障自動復原率 | ≥ 80%（模擬 30% 失敗率時） | 整合測試統計成功請求比例 |
| 斷路器開啟後快速失敗延遲 | ≤ 50ms | 斷路器 OPEN 狀態下的 P99 延遲 |
| 超時保護覆蓋率 | 100% 外部呼叫 | 程式碼審查確認所有外部呼叫均有 TimeLimiter |
| 雪崩防護有效性 | 執行緒池使用率 ≤ 70% | 下游全部故障時的執行緒池監控 |
| Metrics 可觀測性 | 100% 韌性事件可追蹤 | Actuator endpoint 驗證 |

### 4.2 後續生產環境指標（PoC 後規劃）

| 指標 | 基線 | 目標 |
|------|------|------|
| 結帳流程可用性 | 99.5% | 99.9% |
| 單次故障影響時長 | 45 分鐘 | ≤ 5 分鐘 |
| 無效重試請求量 | 50 萬次/事件 | ≤ 1,000 次/事件 |

---

## 5. 範圍定義

### 5.1 In Scope（PoC 範圍）

- 訂單服務對庫存服務、支付閘道、物流服務三個下游呼叫的韌性保護
- Retry、CircuitBreaker、TimeLimiter 三種模式的獨立配置與組合使用
- 下游服務以 Mock/Stub 方式模擬各種故障場景
- 韌性事件的日誌輸出與 Actuator metrics 暴露
- 整合測試與故障場景自動化驗證

### 5.2 Out of Scope（不在 PoC 範圍）

- 分散式追蹤整合（Zipkin/Jaeger）
- 告警通知機制（Grafana Alert）
- 生產環境部署與容量規劃
- Bulkhead（隔板）模式（後續 Phase 2）
- RateLimiter（限流）模式（後續 Phase 2）
- 前端 UI 降級處理
- 非同步訊息補償機制（MQ-based retry）

---

## 6. 風險與假設

### 6.1 假設

1. 下游服務（庫存、支付、物流）均提供 RESTful API 介面
2. 下游服務的故障模式以暫時性故障為主（非永久性架構變更）
3. 支付閘道支援基於冪等鍵的防重複扣款機制
4. PoC 環境可獨立部署，不影響現有生產流量

### 6.2 風險

| 風險 | 影響 | 緩解措施 |
|------|------|---------|
| Resilience4j 配置參數需長期調優 | 初始參數可能不適合生產流量特性 | PoC 階段記錄各參數對行為的影響，建立調參指南 |
| 重試造成下游重複處理 | 資金操作重複扣款 | 強制要求冪等鍵機制 |
| 斷路器誤開啟 | 正常流量被拒絕 | 設定合理的滑動窗口大小與失敗率閾值 |
| TimeLimiter 過短導致正常請求被截斷 | 成功率下降 | 基於 P99 延遲數據設定超時值 |

---

## 7. 時程規劃

| 階段 | 工作項目 | 預估時間 |
|------|---------|---------|
| Phase 1 | 環境建置與技術選型確認 | 1 天 |
| Phase 2 | 核心程式碼開發（三模式獨立實作） | 3 天 |
| Phase 3 | 三模式組合整合與調優 | 2 天 |
| Phase 4 | 故障場景測試與指標驗證 | 2 天 |
| Phase 5 | 文件撰寫與 PoC 成果展示 | 1 天 |
| **合計** | | **9 個工作天** |

---

## 8. 相關方與審核

| 角色 | 職責 |
|------|------|
| 架構組 | PoC 設計與實作、技術選型 |
| 開發團隊 | 程式碼實作與測試 |
| SRE 團隊 | 可觀測性需求確認、監控指標審核 |
| 產品負責人 | 業務場景確認、降級策略審核 |
| 資安團隊 | 冪等性機制與重試策略安全審核 |
