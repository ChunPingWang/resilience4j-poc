# Feature Specification: Resilience4j 韌性機制 PoC — 電子商務訂單流程

**Feature Branch**: `001-resilience4j-poc`
**Created**: 2026-02-02
**Status**: Draft
**Input**: PRD.md — Resilience4j Retry + CircuitBreaker + TimeLimiter PoC

## Clarifications

### Session 2026-02-02

- Q: 當服務回應時間超過慢呼叫門檻但未達超時時，這些慢呼叫是否應計入斷路器的失敗統計？ → A: 慢呼叫計入失敗統計（slowCallRateThreshold=80%，慢呼叫定義：庫存/物流 >2s，支付 >3s）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 暫時性故障自動復原 (Priority: P1)

身為正在結帳的消費者，當庫存服務因網路抖動短暫不可用時，我希望系統能自動重試而非立刻失敗，讓我無感地完成結帳。

**Why this priority**: 這是韌性機制的基礎能力。自動重試能在最常見的暫時性故障場景中維持服務可用性，直接提升使用者體驗與交易成功率。

**Independent Test**: 可透過模擬庫存服務返回暫時性錯誤（如 503），驗證系統自動重試後成功完成扣減，使用者不會感知到任何錯誤。

**Acceptance Scenarios**:

1. **Given** 庫存服務首次請求返回 503 錯誤, **When** 系統發起庫存扣減請求, **Then** 系統自動在 500ms 後重試
2. **Given** 庫存服務前兩次返回 503、第三次返回成功, **When** 系統進行重試, **Then** 最終扣減成功，使用者收到成功回應
3. **Given** 庫存服務返回 400（參數錯誤）, **When** 系統發起請求, **Then** 系統不進行重試，直接返回業務錯誤
4. **Given** 庫存服務返回 409（庫存不足）, **When** 系統發起請求, **Then** 系統不進行重試，返回「庫存不足」業務提示
5. **Given** 庫存服務連續三次皆返回 503, **When** 重試次數耗盡, **Then** 系統返回「庫存確認暫時無法完成，請稍後重試」

---

### User Story 2 - 支付閘道快速失敗保護 (Priority: P2)

身為正在結帳的消費者，當支付閘道持續故障時，我不希望每次結帳都等待漫長的超時，而是立即收到系統提示並可選擇其他支付方式。

**Why this priority**: 斷路器是防止雪崩效應的關鍵機制。當下游服務持續故障時，快速失敗能保護上游資源，避免執行緒池耗盡導致整體系統不可用。

**Independent Test**: 可透過連續發送失敗請求使斷路器開啟，驗證後續請求在 50ms 內收到快速失敗回應，而非等待完整超時。

**Acceptance Scenarios**:

1. **Given** 支付閘道在 10 次呼叫中失敗率達 60%, **When** 斷路器判斷失敗率超過閾值, **Then** 斷路器狀態變為 OPEN
2. **Given** 斷路器為 OPEN 狀態, **When** 新的支付請求進入, **Then** 請求在 50ms 內返回快速失敗，不實際呼叫支付閘道
3. **Given** 斷路器為 OPEN 狀態, **When** 快速失敗發生, **Then** 返回訊息「支付服務暫時不可用，請嘗試其他支付方式或稍後重試」
4. **Given** 斷路器 OPEN 狀態已維持 30 秒, **When** 等待時間到達, **Then** 斷路器進入 HALF_OPEN 狀態，允許 5 個探測請求通過
5. **Given** 斷路器為 HALF_OPEN 狀態且探測請求成功率 ≥ 60%, **When** 探測完成, **Then** 斷路器恢復為 CLOSED 狀態，正常處理所有請求

---

### User Story 3 - 物流服務超時保護 (Priority: P3)

身為正在結帳的消費者，即使物流服務回應緩慢，我也不希望結帳頁面無限 loading，應在合理時間內收到回應。

**Why this priority**: 超時保護確保任何外部呼叫都有明確的時間上限，避免慢回應阻塞執行緒。物流建單可延後處理，因此採用降級策略而非完全失敗。

**Independent Test**: 可透過模擬物流服務延遲 5 秒回應，驗證系統在 3 秒後觸發超時並返回降級回應。

**Acceptance Scenarios**:

1. **Given** 物流服務呼叫超過 3 秒未回應, **When** 超時發生, **Then** 系統中斷等待並觸發降級邏輯
2. **Given** 物流服務超時觸發, **When** 處理降級, **Then** 系統返回「物流單號將稍後以通知方式提供」
3. **Given** 物流服務超時, **When** 超時事件發生, **Then** 此次失敗計入斷路器的失敗統計
4. **Given** 物流服務超時, **When** 系統處理超時, **Then** 正確取消底層連線並釋放資源

---

### User Story 4 - 三模式協作完整保護 (Priority: P4)

身為系統維運人員，我希望 Retry、CircuitBreaker、TimeLimiter 三種機制能正確協作，確保在各種故障組合下都能提供合理的降級回應。

**Why this priority**: 這是整合驗證，確保三種機制的疊加使用不會產生衝突或非預期行為。

**Independent Test**: 可透過組合故障場景（如超時 + 斷路器開啟），驗證機制執行順序正確且各自功能不受影響。

**Acceptance Scenarios**:

1. **Given** 三種機制同時配置, **When** 請求發起, **Then** 執行順序為 TimeLimiter → CircuitBreaker → Retry → 實際呼叫
2. **Given** 斷路器為 OPEN 狀態, **When** 請求進入, **Then** 直接跳過重試邏輯，立即返回快速失敗
3. **Given** 單次呼叫超時觸發, **When** 仍有重試次數, **Then** 進行下一次重試嘗試
4. **Given** 任何韌性事件（重試、斷路、超時）發生, **When** 事件觸發, **Then** 系統產生結構化日誌與量測指標

---

### Edge Cases

- 當三個下游服務同時故障時，各服務的斷路器應獨立運作，互不影響
- 重試過程中如果斷路器從 CLOSED 變為 OPEN，當次重試應立即終止
- 支付請求的冪等鍵必須在重試過程中保持一致，避免重複扣款
- 當 TimeLimiter 超時觸發時，即使底層請求後續成功，也應忽略其結果
- 斷路器從 OPEN 轉 HALF_OPEN 的過程中到達的請求，應按 OPEN 狀態處理

## Requirements *(mandatory)*

### Functional Requirements

**重試機制 (Retry)**

- **FR-001**: 系統 MUST 對暫時性錯誤（HTTP 500、502、503、504、429）自動進行重試
- **FR-002**: 系統 MUST 對網路層錯誤（ConnectException、SocketTimeoutException）自動進行重試
- **FR-003**: 系統 MUST NOT 對業務錯誤（HTTP 400、401、403、404、409）進行重試
- **FR-004**: 系統 MUST 採用指數退避策略，基礎間隔為 500ms，倍數為 2.0
- **FR-005**: 系統 MUST 限制最大重試次數為 3 次（含首次嘗試）
- **FR-006**: 支付請求 MUST 在每次重試時攜帶相同的冪等鍵（idempotency-key）

**斷路器 (CircuitBreaker)**

- **FR-007**: 系統 MUST 使用計數型滑動窗口，窗口大小為 10 次呼叫
- **FR-008**: 當窗口內失敗率達到 60% 時，斷路器 MUST 轉為 OPEN 狀態
- **FR-009**: 支付閘道的失敗率閾值 MUST 設為 50%（較敏感）
- **FR-010**: 斷路器 OPEN 狀態 MUST 維持 30 秒後自動轉為 HALF_OPEN
- **FR-011**: HALF_OPEN 狀態 MUST 允許 5 個探測請求通過
- **FR-012**: 探測請求成功率 ≥ 60% 時，斷路器 MUST 恢復為 CLOSED 狀態
- **FR-013**: 斷路器 OPEN 狀態下的請求 MUST 在 50ms 內返回快速失敗
- **FR-025**: 系統 MUST 將慢呼叫計入斷路器失敗統計，慢呼叫率閾值為 80%
- **FR-026**: 慢呼叫定義：庫存服務 >2 秒、物流服務 >2 秒、支付閘道 >3 秒

**超時控制 (TimeLimiter)**

- **FR-014**: 庫存服務呼叫的超時上限 MUST 為 4 秒（涵蓋完整重試週期）
- **FR-015**: 支付閘道呼叫的超時上限 MUST 為 8 秒（涵蓋完整重試週期）
- **FR-016**: 物流服務呼叫的超時上限 MUST 為 3 秒
- **FR-017**: 超時觸發時，系統 MUST 正確取消底層執行並釋放資源
- **FR-018**: 超時事件 MUST 計入斷路器的失敗統計

**降級策略**

- **FR-019**: 庫存服務失敗時，系統 MUST 拒絕建立訂單並提示使用者稍後重試
- **FR-020**: 支付閘道失敗時，系統 MUST 提示使用者更換支付方式或稍後重試
- **FR-021**: 物流服務失敗時，系統 MUST 先建立訂單，物流單號延後以通知方式提供

**可觀測性**

- **FR-022**: 所有韌性事件 MUST 輸出結構化日誌，包含事件類型、服務名稱、嘗試次數
- **FR-023**: 系統 MUST 暴露斷路器狀態、失敗率、重試統計等量測指標
- **FR-024**: 系統 MUST 支援透過健康檢查端點查詢斷路器狀態

### Key Entities

- **Order（訂單）**: 代表一筆結帳交易，包含訂單編號、訂單項目、訂單狀態、建立時間
- **OrderItem（訂單項目）**: 訂單中的單一商品，包含 SKU 代碼、數量、單價
- **InventoryReservation（庫存預留）**: 庫存扣減記錄，包含 SKU、預留數量、預留狀態
- **PaymentTransaction（支付交易）**: 支付記錄，包含交易編號、金額、冪等鍵、支付狀態
- **ShipmentRequest（物流請求）**: 物流建單請求，包含訂單編號、收件地址、物流單號（可為待定）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在模擬 30% 暫時性故障率的環境下，自動復原成功率 ≥ 80%
- **SC-002**: 斷路器 OPEN 狀態下，快速失敗回應延遲 ≤ 50ms（P99）
- **SC-003**: 所有外部服務呼叫 100% 具備超時保護
- **SC-004**: 當下游服務全部故障時，上游系統資源使用率維持 ≤ 70%
- **SC-005**: 100% 韌性事件可透過日誌或量測指標追蹤
- **SC-006**: 正常情況下（無故障），訂單結帳流程 P95 延遲 ≤ 3 秒
- **SC-007**: 降級情況下（含重試），訂單結帳流程最大延遲符合超時設定（庫存 4 秒、支付 8 秒、物流 3 秒）
- **SC-008**: 無效重試請求量降低至每次故障事件 ≤ 1,000 次（相較現況 50 萬次）

## Assumptions

- 下游服務（庫存、支付、物流）均提供 RESTful API 介面
- 下游服務的故障模式以暫時性故障為主（非永久性架構變更）
- 支付閘道支援基於冪等鍵的防重複扣款機制
- PoC 環境可獨立部署，不影響現有生產流量
- 測試環境使用模擬服務（Mock/Stub）來驗證各類故障場景

## Out of Scope

- 分散式追蹤整合（Zipkin/Jaeger）
- 告警通知機制（Grafana Alert）
- 生產環境部署與容量規劃
- Bulkhead（隔板）模式
- RateLimiter（限流）模式
- 前端 UI 降級處理
- 非同步訊息補償機制（MQ-based retry）
